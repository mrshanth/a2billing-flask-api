# Process and Code flow of Enhanced Rack Pricing:

## 1. Objective
To understand
1. Enhanced Rack Pricing process
2. Sequence in which the sas codes are executed

## 2. Enhanced Rack Pricing process (WIP)

### 2.1 Summary
The predictive models are generated by the **Weekly Batch** module. The generated models are then used by the **On Demand** module, to select the best module. Before the best model is chosen, forecast scenarios and beta bounds are calculated. Subsequently, forecast from different scenarios and beta restrictions, are used by the optimisation code.



## 3. Code Flow

1. **Weekly Batch** module has 9 files
2. **On Demand** module has 32 sas files 

## 3.1 Weekly Batch Module

1. __e_r_wrapper_WEEKLY_UPDATE.sas__. The following scripts are called from this sas file:

	* e_r_macro_COMMON_MACROS.sas
	* e_r_macro_SET_ATOM_INPUT_OVER_ROOMS.sas
	* e_r_macro_CREATE_STRAT_VALUE_INPUT.sas
	2. __e_r_utility_SET_PARAMETERS_AND_DATASETS.sas__
	3. __e_r_macro_DISTRIBUTE_PARALLEL_UPDATE.sas__: The following macro/sas files are called from this sas file:

		4. __e_r_macro_CREATE_RACK_DATA.sas__
		5. __e_r_macro_PREPARE_UPDATE_DATA.sas__: Creates the tables needed to update data on the weekly basis
		6. __e_r_macro_FIT_MODEL.sas__ : Create plm objects for data forecasting and save rack coefficients from each model. The following macros/ sas files from **On Demand** module is used:
			* __e_r_macro_CREATE_OBJECT_MODEL1.sas__
			* __e_r_macro_CREATE_OBJECT_MODEL2.sas__
			* __e_r_macro_CREATE_OBJECT_MODEL3.sas__
			* __e_r_macro_CREATE_OBJECT_MODEL4.sas__
			* __e_r_macro_CREATE_OBJECT_MODEL5.sas__
			* __e_r_macro_CREATE_OBJECT_MODEL6.sas__
		7. 	__e_r_macro_UPDATE_MAPES.sas__ : Calculate MAPE's for three different holdout periods in order to have a measurement of the predictive power of the model.  An average of the three MAPE is used in coefficient selection to determine the best model to use.  This code need not be run every time the batch runs.  It only needs to run every 6 months or so to update the MAPES in the data set. The following macros / sas files are called from **On Demand** module:
			* __e_r_macro_FIT_MODEL.sas__
			* __e_r_macro_CREATE_OBJECT_MODEL1.sas__
			* __e_r_macro_CREATE_OBJECT_MODEL2.sas__
			* __e_r_macro_CREATE_OBJECT_MODEL3.sas__
			* __e_r_macro_CREATE_OBJECT_MODEL4.sas__
			* __e_r_macro_CREATE_OBJECT_MODEL5.sas__
			* __e_r_macro_CREATE_OBJECT_MODEL6.sas__
		* __e_r_macro_GENERATE_FORECAST_SKELETON.sas__ : From ** On Demand** module
		* __e_r_macro_CALCULATE_BETA_BOUNDS.sas__ : From ** On Demand** module
		* __e_r_macro_SELECT_MODELS.sas__ : From ** On Demand** module
		8. __e_r_macro_RECORD_WEEKLY_MAPE.sas__ : To Create an ut of sample mape to record how well models are forecasting. The following macros/sas files are called :
			* **Weekly Module**
				* __e_r_macro_FIT_MODEL.sas__ 
				9. __e_r_macro_RECORD_WEEKLY_STATISTICS.sas__
			* **On Demand Module**
				* __e_r_macro_CREATE_OBJECT_MODEL1.sas__
				* __e_r_macro_CREATE_OBJECT_MODEL2.sas__
				* __e_r_macro_CREATE_OBJECT_MODEL3.sas__
				* __e_r_macro_CREATE_OBJECT_MODEL4.sas__
				* __e_r_macro_CREATE_OBJECT_MODEL5.sas__
				* __e_r_macro_CREATE_OBJECT_MODEL6.sas__


## 3.2 On Demand Module

1. __e_r_wrapper_ON_DEMAND.sas__. The following scripts are called from this sas file:
	
	### Configuration Block (e_r_wrapper_ON_DEMAND.sas)
	* e_r_macro_SET_ATOM_INPUT_OVER_ROOMS.sas (missing file)
	* e_r_macro_CREATE_INFLUENCER_INPUT.sas (missing file)
	* e_r_macro_CREATE_STRAT_VALUE_INPUT.sas (missing file)
	* e_r_macro_CREATE_PENALTY_WEIGHT_SET.sas (missing file)
	* e_r_macro_PROCESS_UI_NON_RACK_VOLUME_INFO.sas (missing file)
	
	### Forecast and Optimisation Block (e_r_wrapper_ON_DEMAND.sas)
	2. __e_r_utility_SET_PARAMETERS.sas__ : Set initial parameters
	3.  __e_r_macro_DISTRIBUTE_PARALLEL_TASKS.sas__: Some of the arguments of the macro:
		* Data path
		* user
		* password
		* model_run_id
		* model_Name

		### Model Selection Block (e_r_macro_DISTRIBUTE_PARALLEL_TASKS.sas)
		4. __e_r_macro_CREATE_MODEL_SELECTION_DATA_SETS.sas__ : Creates empty data sets for model selection. 
			
		5. __e_r_macro_GENERATE_FORECAST_SKELETON.sas__: Create a forecast skeleton dataset to feed forecasting and limbo forecast modules. The following macros/files called:
			6. __e_r_macro_GENERATE_MOVIE_WEEK.sas__ :Generate Movie Weeks for all dates between andy two given dates.  Cannot use dates before year 2000.  Weekdays begin on Wednesdays for movie weeks.  Also, weeks in a year go to 56 with the first week of the year overlapping with the 56th week of the previous year.  Weeks that may not present in a movie_week calendar are 6, 13, 27, 35, and 42.  Presidents day falls on week 8, Memorial day on 23, Independence day on 29, Labor day on 38, Thanksgiving on 51, and Christmas on 55.
			7. __e_r_macro_FORECAST_SCHOOL_CALENDAR.sas__: orecast pct_vacation for dates not generated by school calendar using proc glimmix.
			8. __e_r_macro_CREATE_REFERENCE_PRICE.sas__: Macro for creating reference price and dates which correspond roughly to the the date most similar to a given date for purpose of price comparison. This script calls the following macro/ sas file:
				9. __e_r_macro_FETCH_RACKRATES_AND_SEASONS.sas__
			
			Some of the arguments of the __GENERATE_FORECAST_SKELETON__ macro:
			* Interim
			* Begin date
			* End date
			* Property Code
			* Room type
			* model_effective_date
			* Publish date
			* Model Run ID
			* Model Name		
			
        ### 

		10. __e_r_macro_CALCULATE_BETA_BOUNDS.sas__: Calculate Bounds for rack coefficients that give favorable results.  Three tiers of bea bounds are created in order to rate how confident the product is in selection of the model. Some of the argyments:
			* Interim
			* Property Code
			* Room type
			* model_count
		  
		11. __e_r_macro_SELECT_MODELS.sas__: Select the best Rack / reference price coefficient for optimization. Calculates a model selection metric based on rack / reference price coefficient AND MAPE for the corresponding model AND compares to select best model / coefficient*/. The following model scripts are run to choose the best model:
		    12. __e_r_macro_PREPARE_MODEL_FIT.sas__:Uses proc logistic to create spline knots for use in proc glm.  This method is used to avoid using proc glimmix as it is a slower process
			13. __e_r_macro_CREATE_OBJECT_MODEL1.sas__
			14. __e_r_macro_CREATE_OBJECT_MODEL2.sas__
			15. __e_r_macro_CREATE_OBJECT_MODEL3.sas__
			16. __e_r_macro_CREATE_OBJECT_MODEL4.sas__
			17. __e_r_macro_CREATE_OBJECT_MODEL5.sas__
			18. __e_r_macro_CREATE_OBJECT_MODEL6.sas__

		    Some of the arguments for the __SELECT_MODELS__ macro:
			* Interim
			* Property Code
			* Room type
			* model_count

		### Remaining Capacity Block (e_r_macro_DISTRIBUTE_PARALLEL_TASKS.sas)

		19. __e_r_macro_COMPUTE_LIMBO_FORECAST.sas__: Macro for looking into rooms already booked for dates of interested.  Calls a data query then formats data
			The following macro/sas file is called:
			20. __e_r_macro_LIMBO_FORECAST.sas__ :Generate "limbo" forecast that predicts rack bookings FROM model run date until rack publish date.This is dependent ON what mode is being run.
			
			Some of the arguments for the __COMPUTE_LIMBO_FORECAST__ macro:
			* Interim
			* Property Code
			* Room type
			* Begin date
			* End data
			* Model effective date
		  
		21. __e_r_macro_COMPUTE_REMAINING_CAPACITY.sas__ : Remaining capacity calculation. Some of the arguments for the macro:
			* Interim
			* Property Code
			* Room type
			* Begin date
			* End data
			* Model effective date
        ### Forecast and Optimisation Block (e_r_macro_DISTRIBUTE_PARALLEL_TASKS.sas)

		22. __e_r_macro_PREPARE_PRE_FORECAST_DATA.sas__ : creating datasets that were filtered on property code, room type. Some of the arguments for the macro:
			* Property code
			* Room type
			* Tier

		23. __e_r_macro_FIND_MAX_MIN_RACK.sas__ : Purpose: Calculate historical maximum and minimum price for neighbouring days. Some of the arguments for the macro:
			* Property code
			* Room type
			* Max price
			* Adjacent Days
			
		24. __e_r_macro_PRODUCE_FORECASTS_AND_OPTIMIZE.sas__ : Loop for calculating optimal price and formatting final data sets.

			The following scripts are called in this macro:
			25. __e_r_macro_GENERATE_DATE_RANGES.sas__ : Macro that creates date bins for optimization
			26. __e_r_macro_GENERATE_FORECAST.sas__: Run forecast along with corrections.
			27. __e_r_macro_PREPARE_POST_FORECAST_DATA.sas__ :   creating datasets that were filtered on property code, room type and service date range
			28. __e_r_macro_GENERATE_OPTIMAL_OUTPUT.sas__ : Run optimization (MIP) for given service dates AND room types. It is called twice, with the following penalties:
				* Optimisation with RR penalty
				* Optimisation with OI penalty
			29. __e_r_macro_GENERATE_SCENARIO_BASED_OUTPUT.sas__

	### Post Processing (e_r_wrapper_ON_DEMAND.sas)
		
	30. __e_r_macro_CALCULATE_CONFIDENCE_METRICS.sas__ : All outputs FROM batch run, pre-determined score function are used to compute the confidence metrics
	31. __e_r_macro_GENERATE_FINAL_OUTPUT.sas__: Join AND (eventually) rename all output to conform with accepted output structure

sas files not used in the sequential flow:

32. __e_r_utility_PROCESS_LOGS.sas__



